# WebSocket 지원을 위한 Connection 헤더 동적 매핑
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# ============================================
# HTTP 설정 (로컬 개발용 - HTTPS 적용 시 주석 처리됨)
# ============================================
# server {
#     listen 80;
#     server_name localhost;
#     client_max_body_size 40m;
#
#     location / {
#         proxy_pass http://springboot:8080;
#         proxy_http_version 1.1;
#
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection $connection_upgrade;
#         proxy_read_timeout 3600s;
#         proxy_send_timeout 3600s;
#         proxy_buffering off;
#     }
#
#     location /api/notifications/stream {
#         proxy_pass http://springboot:8080;
#         proxy_http_version 1.1;
#
#         proxy_set_header Connection '';
#         proxy_set_header X-Accel-Buffering no;
#         proxy_buffering off;
#         proxy_cache off;
#
#         chunked_transfer_encoding on;
#
#         proxy_read_timeout 3600s;
#         proxy_send_timeout 3600s;
#
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
#
#     location /api/simulations/stream {
#         proxy_pass http://springboot:8080;
#         proxy_http_version 1.1;
#
#         proxy_set_header Connection '';
#         proxy_set_header X-Accel-Buffering no;
#         proxy_buffering off;
#         proxy_cache off;
#
#         chunked_transfer_encoding on;
#
#         proxy_read_timeout 3600s;
#         proxy_send_timeout 3600s;
#
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
#
#     access_log /var/log/nginx/access.log;
#     error_log /var/log/nginx/error.log;
# }

# ============================================
# HTTPS 설정 (Let's Encrypt 인증서 발급 후 활성화)
# ============================================
#
# 사용 방법:
# 1. 도메인 준비: my-ball.site
# 2. Let's Encrypt 인증서 발급:
#    docker-compose stop nginx
#    docker run -it --rm --name certbot \
#      -v "/etc/letsencrypt:/etc/letsencrypt" \
#      -v "/var/lib/letsencrypt:/var/lib/letsencrypt" \
#      -p 80:80 \
#      certbot/certbot certonly --standalone -d my-ball.site -d www.my-ball.site
# 3. 아래 주석 해제 (인증서 발급 후)
# 4. docker-compose restart nginx
# ============================================

# HTTPS 서버
server {
    listen 443 ssl;
    http2 on;  # 최신 문법
    server_name my-ball.site www.my-ball.site;
    client_max_body_size 40m;

    # SSL 인증서 경로
    ssl_certificate /etc/letsencrypt/live/my-ball.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/my-ball.site/privkey.pem;

    # SSL 보안 설정 (최신 권장 설정)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # ============================================
    # 보안 헤더 추가 (XSS, Clickjacking 방지)
    # ============================================
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ============================================
    # 악성 요청 차단 (WordPress, phpMyAdmin 등)
    # ============================================
    location ~ ^/(wordpress|wp-admin|wp-login|wp-content|wp-includes|phpmyadmin|pma|manager|xmlrpc\.php) {
        return 444;  # Nginx 특수 코드: 응답 없이 연결 종료
    }

    # 의심스러운 파일 확장자 차단
    location ~* \.(asp|aspx|jsp|cgi|sh|bat|exe|dll|bak|old|sql|conf)$ {
        return 444;
    }

    # 숨김 파일 접근 차단 (.git, .env 등)
    location ~ /\. {
        deny all;
        return 404;
    }

    # 모든 요청을 Spring Boot로 전달
    location / {
        proxy_pass http://springboot:8080;
        proxy_http_version 1.1;

        # 호스트 헤더 전달
        proxy_set_header Host $host;
        # 실제 클라이언트 IP 전달
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # 프로토콜 전달 (HTTPS)
        proxy_set_header X-Forwarded-Proto $scheme;

        # 웹 소켓 연결을 위해 필수
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        # WebSocket 장시간 연결 지원
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        # 웹 소켓 버퍼링 비활성화
        proxy_buffering off;
    }

    # SSE (Server-Sent Events) 지원
    location /api/notifications/stream {
        proxy_pass http://springboot:8080;
        proxy_http_version 1.1;

        # SSE 필수 헤더
        proxy_set_header Connection '';
        proxy_set_header X-Accel-Buffering no;
        proxy_buffering off;
        proxy_cache off;

        # 청크 인코딩 활성화
        chunked_transfer_encoding on;

        # 타임아웃 설정
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;

        # 기본 헤더
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/simulations/stream {
        proxy_pass http://springboot:8080;
        proxy_http_version 1.1;

        # SSE 필수 헤더
        proxy_set_header Connection '';
        proxy_set_header X-Accel-Buffering no;
        proxy_buffering off;
        proxy_cache off;

        # 청크 인코딩 활성화
        chunked_transfer_encoding on;

        # 타임아웃 설정
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;

        # 기본 헤더
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Passwordless REST API 프록시
    location /passwordless-api {
        proxy_pass http://auth.my-ball.site:11040/;
        proxy_http_version 1.1;

        proxy_set_header Host auth.my-ball.site:11040;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;

        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
    }

    # ============================================
    # FastAPI 직접 프록시 (외부 콜백용)
    # ============================================

    # Suno AI 콜백 엔드포인트 (외부 Suno 서비스 → FastAPI)
    location /api/ai/suno/callback {
        proxy_pass http://fastapi:8020/api/ai/suno/callback;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 콜백 타임아웃
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;

        # 대용량 응답 지원
        client_max_body_size 10m;
    }

    # 정적 오디오 파일 제공 (Suno가 다운로드하는 파일)
    location /static_audio/ {
        proxy_pass http://fastapi:8020/static_audio/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 오디오 파일 다운로드 타임아웃
        proxy_read_timeout 120s;
        proxy_send_timeout 120s;

        # 대용량 오디오 파일 지원
        client_max_body_size 50m;
    }

    # 로그 설정
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}

# HTTP를 HTTPS로 리다이렉트
server {
    listen 80;
    server_name my-ball.site www.my-ball.site;
    return 301 https://$server_name$request_uri;
}
