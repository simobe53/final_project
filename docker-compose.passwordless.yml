version: '3.8'

services:
  # Passwordless X1280 Authentication Server
  passwordless:
    image: dualauth/passwordless-x1280-single
    container_name: kbo-passwordless
    ports:
      - "8143:8143"   # HTTPS Admin (관리자 접속)
      - "8080:8080"   # Simple UI (외부 접속)
      - "11040:11040" # REST API (Spring Boot에서 사용)
      - "12010:12010" # User Connection (필수)
      - "15010:15010" # WebSocket (Push Connector)
    environment:
      - TZ=Asia/Seoul
      - DOMAIN=auth.my-ball.site  # Passwordless 전용 서브도메인
      - USE_SSL=true              # SSL 활성화
      - SSL_CERT_PATH=/etc/opt/x1280/ssl/cert.pem
      - SSL_CERT_KEY_PATH=/etc/opt/x1280/ssl/privkey.pem
      - AUTH_KEYSTORE_FILE_PATH=/etc/opt/x1280/ssl/tomcat.keystore
      - AUTH_KEYSTORE_PASS=changeit
    volumes:
      # 설정 영속성을 위한 볼륨 (컨테이너 재시작 시에도 유지)
      - passwordless-auth-settings:/opt/x1280/tomcat/conf/passwordless
      - passwordless-database:/var/lib/mysql
      - passwordless-config:/etc/opt/x1280
    restart: unless-stopped

# Named volumes
volumes:
  # Passwordless X1280 볼륨 (설정 영속성)
  passwordless-auth-settings:
    driver: local
  passwordless-database:
    driver: local
  passwordless-config:
    driver: local
